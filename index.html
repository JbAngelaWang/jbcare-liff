<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>JB Care LIFF</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>

<h2>載入中...</h2>

<script>

async function main() {

  await liff.init({ liffId: "2009110865-FvR3qo6e" });

  if (!liff.isLoggedIn()) {
    liff.login();
    return;
  }

  const idToken = liff.getDecodedIDToken();
  const userId = idToken.sub;

  const params = new URLSearchParams(window.location.search);
  const utm_source = params.get("utm_source");
  const utm_campaign = params.get("utm_campaign");
  const utm_content = params.get("utm_content");

  await fetch("這裡先留空", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      userId,
      utm_source,
      utm_campaign,
      utm_content
    })
  });

  const friendship = await liff.getFriendship();

  if (!friendship.friendFlag) {
    liff.openWindow({
      url: "https://line.me/R/ti/p/@jbcare",
      external: true
    });
  } else {
    document.body.innerHTML = "<h2>已是好友 ✅</h2>";
  }

}

main();

</script>

</body>
</html>
