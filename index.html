<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>JB Care LIFF GET 最終版</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body { font-family: Arial; text-align: center; padding-top: 50px; }
h2 { color: #333; }
</style>
</head>
<body>

<h2 id="status">載入中...</h2>

<script>
async function main() {
  const statusEl = document.getElementById("status");

  try {
    await liff.init({ liffId: "2009110865-FvR3qo6e" });

    if (!liff.isLoggedIn()) { liff.login(); return; }

    statusEl.innerText = "LIFF 初始化成功 ✅";

    const idToken = liff.getDecodedIDToken();
    const userId = idToken.sub;

    const params = new URLSearchParams(window.location.search);
    const utm_source = params.get("utm_source") || "";
    const utm_campaign = params.get("utm_campaign") || "";
    const utm_content = params.get("utm_content") || "";

    // GET URL 傳資料到 Google Sheet
    const url = 'https://script.google.com/macros/s/AKfycbxBh6o0xQSJl0AvKfgQAFDwQ_LVRRYIMb5Wdy_8S02WG8ih5R101IdMARsrTIm3Ht_9/exec'
      + '?userId=' + encodeURIComponent(userId)
      + '&utm_source=' + encodeURIComponent(utm_source)
      + '&utm_campaign=' + encodeURIComponent(utm_campaign)
      + '&utm_content=' + encodeURIComponent(utm_content);

    try {
      const response = await fetch(url);
      if (!response.ok) throw new Error("Web App 回傳錯誤");
      statusEl.innerText = "資料已成功送出 ✅";
    } catch(fetchErr) {
      console.error("傳送資料錯誤:", fetchErr);
      statusEl.innerText = "資料送出失敗 ❌，請查看 console";
      return;
    }

    // 好友判斷
    try {
      const friendship = await liff.getFriendship();
      if (!friendship.friendFlag) {
        statusEl.innerText = "尚未加好友，跳轉加好友頁...";
        liff.openWindow({ url: "https://line.me/R/ti/p/@jbcare", external: true });
      } else {
        statusEl.innerText = "已是好友 ✅，開啟聊天室...";
        liff.openWindow({ url: "https://line.me/R/oaMessage/@jbcare", external: true });
      }
    } catch(friendErr) {
      console.error("好友判斷錯誤:", friendErr);
      statusEl.innerText = "好友判斷失敗 ❌，請查看 console";
    }

  } catch(err) {
    console.error("LIFF 初始化錯誤:", err);
    statusEl.innerText = "LIFF 初始化失敗 ❌，請查看 console";
  }
}

main();
</script>

</body>
</html>
